<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ujian KPI — PT SSI</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body { background:#eef2f7; }

    /* Hide helper */
    .hide { display: none; }

    /* Loader */
    #loader {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(255,255,255,0.8);
      backdrop-filter:blur(4px);
      z-index:9999;
      align-items:center;
      justify-content:center;
    }
    .spinner-border {
      width:4rem; height:4rem;
    }

    /* Card Styling */
    .card-custom {
      border-radius:15px;
      border:none;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }

    /* Timer */
    #timer {
      font-size:24px;
      font-weight:bold;
      color:#dc3545;
      text-align:center;
    }
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="spinner-border text-primary"></div>
</div>

<div class="container py-4">
  <h2 class="fw-bold text-center mb-4">POST TEST KASIR</h2>

  <!-- FORM IDENTITAS -->
  <div id="formIdentitas" class="card card-custom p-4">
    <h5 class="fw-bold mb-3">Data Identitas</h5>

    <div class="row g-3">
      <div class="col-md-6">
        <label>Nama Lengkap</label>
        <input type="text" id="nama" class="form-control" required>
      </div>

      <div class="col-md-6">
        <label>NPP</label>
        <input type="text" id="npp" class="form-control" required>
      </div>

      <div class="col-md-6">
        <label>Jabatan</label>
        <input type="text" id="jabatan" class="form-control" required>
      </div>

      <div class="col-md-6">
        <label>COU</label>
        <input type="text" id="cou" class="form-control" required>
      </div>
    </div>

    <button class="btn btn-primary mt-4 w-100" onclick="mulaiUjian()">Mulai Ujian</button>
  </div>

  <!-- AREA SOAL -->
  <div id="areaSoal" class="hide mt-4">
    <div class="card card-custom p-4">
      <div id="timer" class="mb-3">00:00</div>

      <h4 class="text-center mb-4">Soal Ujian</h4>

      <form id="formSoal"></form>

      <button class="btn btn-success mt-3 w-100" onclick="kumpulkan()">Kumpulkan Jawaban</button>
    </div>
  </div>

  <!-- AREA HASIL -->
  <div id="areaHasil" class="hide mt-4">
    <div class="card card-custom p-4 text-center">
      <h3 class="fw-bold text-success">Ujian Selesai</h3>
      <p class="mt-3">Terima kasih telah menyelesaikan ujian.</p>

      <h4 id="hasilScore" class="fw-bold mt-2"></h4>
      <h6 id="hasilWaktu" class="text-muted"></h6>

      <button class="btn btn-secondary mt-4" onclick="location.reload()">Ujian Baru</button>
    </div>
  </div>

</div>

<script>
/* ====== Konfigurasi ====== */
// URL Apps Script
const API_URL = "https://script.google.com/macros/s/AKfycbzs6CjprspmrLGZGjRx54q0Xk9juVl4wBL_K9F-t2puAsamJbGS4xGBldyqcw483rXczQ/exec";  // ← GANTI

/* ====== State global ====== */
let soalAsli = [];
const WAKTU_TOTAL = 10 * 60; // 10 menit (dalam detik)
let waktuSisa = WAKTU_TOTAL;
let timerInterval = null;
let timerMulai = null;

function showLoader(show=true){
  document.getElementById("loader").style.display = show ? "flex" : "none";
}

/* ====== Timer ====== */
function mulaiTimer(){
  // reset jika sebelumnya berjalan
  if (timerInterval) clearInterval(timerInterval);

  timerMulai = Date.now();
  // pastikan waktuSisa sudah diset (menggunakan nilai global)
  updateTimerDisplay();

  timerInterval = setInterval(()=>{
    waktuSisa--;
    updateTimerDisplay();

    if(waktuSisa <= 0){
      clearInterval(timerInterval);
      timerInterval = null;
      waktuSisa = 0;
      updateTimerDisplay();
      kumpulkan();
    }
  },1000);
}

function updateTimerDisplay(){
  document.getElementById("timer").innerText = formatTime(waktuSisa);
}

function formatTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

/* ====== MULAI UJIAN ====== */
async function mulaiUjian(){
  showLoader(true);

  try {
    const res = await fetch(API_URL + "?action=getSoal");
    if(!res.ok) throw new Error(res.status + " " + res.statusText);
    const data = await res.json();

    soalAsli = data.soal; 
    buatSoal(soalAsli);

    // reset waktu sebelum memulai
    waktuSisa = WAKTU_TOTAL;

    document.getElementById("formIdentitas").classList.add("hide");
    document.getElementById("areaSoal").classList.remove("hide");

    mulaiTimer();
  } catch(err){
    alert("Gagal memuat soal: " + err);
  } finally {
    showLoader(false);
  }
}

/* ====== UTILITY: RANDOM SOAL ====== */
function shuffleArray(arr){
  // salin dulu supaya original tidak terpengaruh
  return (arr || []).slice().sort(()=>Math.random() - 0.5);
}

/* ====== TAMPILKAN SOAL ====== */
function buatSoal(soalList) {
  let html = "";
  soalList.forEach((s, i) => {

    let kunciFix = (s.kunci || "").trim().toUpperCase();

    html += `
      <div class="soal-box mb-3">
        <b>${i + 1}. ${s.pertanyaan}</b><br>

        <div><input type="radio" name="soal${i}" value="A"> ${s.pilihan[0]}</div>
        <div><input type="radio" name="soal${i}" value="B"> ${s.pilihan[1]}</div>
        <div><input type="radio" name="soal${i}" value="C"> ${s.pilihan[2]}</div>
        <div><input type="radio" name="soal${i}" value="D"> ${s.pilihan[3]}</div>

        <input type="hidden" class="kunci" value="${kunciFix}">
      </div>
    `;
  });

  document.getElementById("formSoal").innerHTML = html;
}




/* ====== KUMPULKAN HASIL ====== */

function kumpulkan() {

  let benar = 0;
  const soalBoxes = document.querySelectorAll(".soal-box");

  soalBoxes.forEach((box, i) => {

    let kunci = box.querySelector(".kunci").value.trim().toUpperCase();
    let selected = box.querySelector(`input[name="soal${i}"]:checked`);
    let jawaban = selected ? selected.value.trim().toUpperCase() : "";

    if (jawaban === kunci) {
      benar++;
    }
  });

  let totalSoal = soalBoxes.length;
  let score = Math.round((benar / totalSoal) * 100);
  let waktu = hitungWaktu();

  let nama = document.getElementById("nama").value;
  let npp = document.getElementById("npp").value;
  let jabatan = document.getElementById("jabatan").value;
  let cou = document.getElementById("cou").value;

  kirimKeSheet(nama, npp, jabatan, cou, score, waktu);
  tampilkanHasil(score, waktu);
}




/* ====== FUNGSIONALITAS WAKTU ====== */
function hitungWaktu(){
  // Waktu yang terpakai = total - sisa
  const terpakai = WAKTU_TOTAL - Math.max(0, waktuSisa);
  return formatTime(terpakai);
}

/* ====== TAMPILKAN HASIL ====== */
function tampilkanHasil(score, waktu){
  document.getElementById("areaSoal").classList.add("hide");

  document.getElementById("hasilScore").innerText = "Score Anda: " + score;
  document.getElementById("hasilWaktu").innerText = "Waktu pengerjaan: " + waktu;

  document.getElementById("areaHasil").classList.remove("hide");
}

async function kirimKeSheet(nama, npp, jabatan, cou, score, waktu){
  try{
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        nama: nama,
        npp: npp,
        jabatan: jabatan,
        cou: cou,
        score: score,
        waktu: waktu
      })
    });

    const data = await res.json();
    console.log("Hasil tersimpan:", data);
  } catch(err){
    console.error("Gagal kirim hasil:", err);
  }
}

/* ====== Utilities kecil untuk keamanan output HTML ====== */
function escapeHtml(str){
  if (!str && str !== 0) return "";
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function escapeAttr(str){
  if (!str && str !== 0) return "";
  return String(str).replaceAll('"','&quot;').replaceAll("'", "&#39;");
}
</script>

</body>
</html>
